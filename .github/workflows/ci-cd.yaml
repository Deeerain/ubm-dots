name: Simple Arch Build

on:
  push:
    tags: ['v*']

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ðŸ”¨ Build and copy
      run: |
        docker run --rm -v "$PWD:/shared" archlinux:latest bash -c "
          # Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°
          pacman -Sy --noconfirm base-devel git
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð¾Ð¼ Ðº shared
          useradd -m -s /bin/bash builder
          usermod -a -G users builder
          chmod 777 /shared
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÐ¼
          cp -r /shared/. /tmp/build/
          chown -R builder:builder /tmp/build
          cd /tmp/build
          sudo -u builder makepkg --syncdeps --noconfirm
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾
          cp *.pkg.tar.zst /shared/ 2>/dev/null || exit 1
          chmod 666 /shared/*.pkg.tar.zst
        "
        
    - name: ðŸš€ Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: "*.pkg.tar.zst"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
