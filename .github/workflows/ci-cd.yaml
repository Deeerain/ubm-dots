name: Simple Arch Build

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: üêã Build Arch package properly
      run: |
        docker run --rm -v "$PWD:/pkg" archlinux:latest bash -c "
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          pacman -Syu --noconfirm --needed
          pacman -S --noconfirm --needed base-devel git sudo
          
          # –°–æ–∑–¥–∞–µ–º –ù–ï-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å–±–æ—Ä–∫–∏
          useradd -m -G wheel -s /bin/bash builder
          echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –≤ –¥–æ–º–∞—à–Ω—é—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é builder
          cp -r /pkg/. /home/builder/
          chown -R builder:builder /home/builder
          
          # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ–¥ builder –∏ —Å–æ–±–∏—Ä–∞–µ–º
          cd /home/builder
          su builder -c '
            # –ß–∏—Å—Ç–∏–º git config –µ—Å–ª–∏ –µ—Å—Ç—å
            git config --global --unset-all http.https://github.com/.extraheader 2>/dev/null || true
            
            # –°–æ–±–∏—Ä–∞–µ–º –ø–∞–∫–µ—Ç
            makepkg --syncdeps --noconfirm --clean --cleanbuild
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–∑–¥–∞–ª—Å—è
            if ls *.pkg.tar.zst 1> /dev/null 2>&1; then
              echo \"‚úÖ –ü–∞–∫–µ—Ç —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ\"
              # –ö–æ–ø–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ–±—â—É—é –ø–∞–ø–∫—É
              cp *.pkg.tar.zst /pkg/
            else
              echo \"‚ùå –ü–∞–∫–µ—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω\"
              exit 1
            fi
          '
        "
        
    - name: üì¶ Verify package was created
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã..."
        ls -la *.pkg.tar.zst || (echo "–ü–∞–∫–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!" && exit 1)
        
    - name: üöÄ Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: "*.pkg.tar.zst"
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
