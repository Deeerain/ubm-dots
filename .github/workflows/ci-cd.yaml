name: Simple Arch Build

on:
  push:
    tags: ['v*']
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: üêã Build without dependency check
      run: |
        # –î–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å
        chmod 777 "$PWD" 2>/dev/null || true
        
        docker run --rm \
          -v "$PWD:/workspace" \
          -w /workspace \
          archlinux:latest \
          bash -c "
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É
            pacman -Syu --noconfirm --needed
            
            # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            useradd -m -u 1000 -s /bin/bash builder
            
            # –ú–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞
            chown -R builder:builder /workspace
            
            # –°–æ–±–∏—Ä–∞–µ–º –ë–ï–ó —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            sudo -u builder makepkg \
              --syncdeps \
              --noconfirm \
              --skipinteg \
              --nocheck \
              --nodeps
          "
          
    - name: üì¶ Verify package
      run: |
        if [ -f *.pkg.tar.zst ]; then
          echo "‚úÖ –ü–∞–∫–µ—Ç —Å–æ–∑–¥–∞–Ω: $(ls *.pkg.tar.zst)"
        else
          echo "‚ùå –ü–∞–∫–µ—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω"
          exit 1
        fi
        
    - name: üöÄ Create release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: "*.pkg.tar.zst"
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
